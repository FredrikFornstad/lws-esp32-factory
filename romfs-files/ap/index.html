<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset=utf-8 http-equiv="Content-Language" content="en"/>
 <title>Setup</title>
 
 <!--
 (this applies to the tab library CSS)
 
Copyright (c) 2017 by Kseso (https://codepen.io/Kseso/pen/JDFto)

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
-->

<style type="text/css">
*, *:after, *:before {
  box-sizing: border-box;
  -moz-box-sizing: border-box;
}
* {margin:0;padding:0;border: 0 none;position: relative;}


section {
  background: rgba(48,166,67,.5);
  width: 80vw;
  max-width: 50rem;
  min-width: 390px;
  height: 55rem;
  margin: 2rem auto;
  box-shadow: 0 0 6px rgba(0,0,0,.4);
}
article {
  position: absolute;
  left: 0;
  top: 150px;
  right: 0;
  bottom: 0;
  padding: 1rem 2rem 0;
  overflow: auto;
  transition: .7s;
  transform: scale(0);
  transform-origin: center center;
  transition-delay: .1s;
}
article:before {
  color: rgba(0,0,0,.2);
  font-size: 4rem;
  font-weight: 100;
  position: absolute;
  bottom: 1rem;
  right: 1rem;
}
h2 {
  font-size: 2.5rem;
  font-weight: 600;
  text-align: center;
  color: rgba(0,0,0,.6);
}
body > h2 {height: auto;}
h2 img {
  width: 120px;
  height: auto;
  background: #f9f9f9;
  border: 5px solid rgba(0,0,0,.7);
  border-radius: 50%;
  padding: 5px;
  display: block;
  margin: 0 auto;
  box-shadow: 0 0 7px rgba(0,0,0,.5);
}
h2 span {
  font-family: Great Vibes;
  font-weight: 400;
  display: block;
  margin-bottom: 1rem;
}
footer ul {
  width: 100%;
  color: #037B49;
}
footer li {
  list-style-type: none;
  float: left;
  width: 20%;
  text-align: center;
  font-size: 3rem;
  font-weight: 100;  
}
p, dl, ol {
  line-height: 1.5;
  font-size: 1.3rem;
}
ol li {margin: 0 0 .5rem 1rem;}
dt {
  font-size: 1.6rem;
  font-weight: 600;
  text-indent: 1.5rem;
}
nav {
  background: rgba(30,103,67,.5);
  width: 100%;
  height: 150px;
  text-align: center;
  box-shadow: 0 0 6px rgba(0,0,0,.4);
}
nav:after {
  content:'';
  width: 33%;
  height: 150px;
  background: rgba(248,246,167,.4);
  position: absolute;
  transition: .5s;
}

label {
  width: 33%;
  float: left;
  color: rgba(48,166,67,.5);
  text-align: center;
  cursor: pointer;
  transition: .5s;
  z-index: 2;
}
label:hover {color: #1E6743;}
label:before {
  display: block;
  font-size: 3rem;
  line-height: 5rem;
    text-align: center;
  z-index: 2;
}
#certs:checked ~ nav [for='certs'],
#wireless:checked ~ nav [for='wireless'],
#updates:checked ~ nav [for='updates'] {
  color: rgba(30,103,67,.5);
  font-weight: 600;
}
#certs:checked ~ nav [for='certs'] {}
#wireless:checked ~ nav [for='wireless'] {}

#certs:checked ~ nav:after {
  left: 0;
}
#wireless:checked ~ nav:after {
  left:33%;
  border-top: 0 none;
}
#updates:checked ~ nav:after {
  left: 67%;
}

#certs:checked ~ .uno,
#wireless:checked ~ .dos,
#updates:checked ~ .tres {
  display: block;
  transform: scale(1);
  transition-delay: .5s; 
}
a {color: rgba(0,0,0,.4)}
a:hover {color: rgba(0,0,0,.2)}

 
th,td { padding: 5px; }
.td-right { text-align: right; }
.td-left { text-align: left; }
.td-center { text-align: center; }
.td-top { vertical-align: top; }
.td-middle { vertical-align: middle; }
.td-bottom { vertical-align: bottom; }
.center-align { text-align: center; }
.center-div { margin-left: auto; margin-right: auto; }
.right-div { margin-left: auto; margin-right: 0; }
.left-div { margin-left: 0; margin-right: auto; }
td.bigt { font-size:40pt; font-weight:normal; text-align:center; color:#000000; }
td.stt { font-size:14pt; font-weight:bold; text-align:center; color:#ffffc0; }
td.scc { font-size:10pt; font-weight:normal; text-align:center; color:#404040;  background-color: rgba(240, 240, 240, 0.6); } 
tdmin { font-size:9pt; font-weight:normal; text-align:center; color:#404040; } 
td.l { background-color: rgba(40, 40, 24, 0.6); color:#c0c0c0; }
tr.ra { background-color: rgba(240, 240, 224, 0.6); color:#303030; }
tr.ras { background-color: rgba(255, 255, 255, 0.8); color:#101010; }
tr.rl { }
.sub { font-size:24pt; font-weight:normal; text-align:center; color:#000000; }
.tabt { font-size:12pt; font-weight:bold; text-align:center; color:#ffffc0; }
.tabv { font-size:12pt; font-weight:normal; text-align:center; color:#000000; }
.it { font-size:14pt; font-weight:bold; text-align:right; color:#404040; }
.itt { font-size:10pt; font-weight:bold; text-align:right; color:#404040; padding: 1px}
.iv { font-size:14pt; font-weight:normal; text-align:left; color:#000000; }
.ivt { font-size:14pt; font-weight:normal; text-align:left; color:#000000; padding: 1px}

.btn { font-size:13pt; font-weight:normal; text-align:center; color:#000000; padding: 5px}
.btn:hover {color: #000; background-color: #fff}
.group2 { vertical-align:middle;
	text-align:center;
	background-color: rgba(240, 240, 224, 0.6); 
	padding:12px; 
	border-radius:10px; }
.div128 { position:relative; overflow:hidden; top: 0px; left: 0px; min-width:128px; width:128px; min-height:128px; height:128px; border:0; }
.div64 { position:relative; overflow:hidden; top: 0px; left: 0px; min-width:64px; width:64px; min-height:64px; height:64px; border:0; }
.div48 { position:relative; overflow:hidden; top: 0px; left: 0px; min-width:48px; width:48px; min-height:48px; height:48px; border:0; }
.div32 { position:relative; overflow:hidden; top: 0px; left: 0px; min-width:32px; width:32px; min-height:32px; height:32px; border:0; }
.div24 { position:relative; overflow:hidden; top: 0px; left: 0px; min-width:24px; width:24px; min-height:24px; height:24px; border:0; }
.img128 { position: absolute; width: 128px; height: 1048px; top: 0px; left: 0px }
#wifi { top: -128px }
#product { top: -512px }
#logo { top: -640px }
#router { top: -768px }
#tls { top: -496px }
.progr { width:100%; height:32px;  background-color: rgba(240, 240, 24, 0.6); color:#c0c0c0; }
.progr-ok { width:100%; height:32px;  background-color: rgba(240, 240, 24, 1.0); color:#e0e060; }
.progr-fail { width:100%; height:32px;  background-color: rgba(240, 240, 24, 1.0); color:#c00000; }
.progr-done { width:100%; height:32px;  background-color: rgba(240, 240, 24, 1.0); color:#00c000; }
#preload-01 { background: url(spinner.gif) no-repeat -9999px -9999px; }
.tooltip {
    position: relative;
    display: inline-block;
    border-bottom: 1px dotted black; /* If you want dots under the hoverable text */
}
.tooltip .tooltiptext {
    visibility: hidden;
    width: 120px;
    opacity: 0.75;
    font-size: 10pt;
    background-color: white;
    color: #000;
    text-align: center;
    padding: 5px 0;
    border-radius: 6px;
    position: absolute;
    z-index: 1;
}
.tooltip:hover .tooltiptext {
    visibility: visible;
}
</style>
</head>

<body style="background-image:url(backdrop.jpg); background-repeat: no-repeat; background-size: cover;">
	<!-- <div id=waiting style="width: 54px; height:52px; margin: auto auto; text-align: center;"><img src=spinner.gif></div> -->
	<div id=realpage style="display:block">
 <table class="center-div" style="width: 600px;">
  <tr><td class="td-center">
   <table>
    <tr><td valign=middle align=center>
     <a href="https://libwebsockets.org"><div class=div128>
      <img id=logo src="setup.png" class=img128>
     </div></a>
    </td><td class="bigt" align=center>Setup</td><td align=center>
	 <!--  <div class=div128><img id=wifi src="setup.png" class=img128></div> -->
	 
	<table>
	 <tr>
	  <td style="vertical-align: top"><div class=div128><img id="inet" src="setup.png" class=img128 style="top: -382px; left: 0px" ></div></td>
	  <td id=conn_td style="margin:2px">
		<table id=conn_data >
			<tr><td class="itt">Joined&nbsp;AP:</td><td class="ivt" style="text-align:left"><span id=conn_ap></span></td></tr>
			  <tr><td class="itt">IP:</td><td class="ivt" style="text-align:left"><span id=conn_ip></span></td></tr>
			  <tr><td class="itt">Netmask:</td><td class="ivt" style="text-align:left"><span id=conn_mask></span></td></tr>
			  <tr><td class="itt">Gateway:</td><td class="ivt" style="text-align:left"><span id=conn_gw></span></td></tr>
		</table>
	  </td>
	 </tr>
        </table>
	 
  </td></tr><tr><td colspan=3>
   <section>

    <input type="radio" id="certs" value="1" name="tractor" style="display:none" checked='checked' />   
    <input type="radio" id="wireless" value="2" name="tractor" style="display:none" />
    <input type="radio" id="updates" value="3" name="tractor" style="display:none" />
    <nav>
     <label for="certs"><table style="width:100%; display:inline; text-align:center">
     	<tr><td><div class=div128><img id=tls class=img128 src="./setup.png"></div></td></tr></table></label>
     <label for="wireless"><table style="width:100%; display:inline; text-align:center">
     	<tr><td><div class=div128><img id=router class=img128 src="./setup.png"></div></td></tr></table></label>
     <label for="updates"><table style="width:100%; display:inline; text-align:center">
     	<tr><td><div class=div128><img class=img128 src="./setup.png"></div></td></tr></table></label>
    </nav>

    <article class='uno'>
        <form name=multipart action="factory" method="post" enctype="multipart/form-data">

	<table class="center-div" style="width: 450px">
	 <tr>
	  <td style="font-size: 12pt">
		<table class="center-div" style="padding:12px; ">
			<tr><td class="tabt">Model</td><td class="tabv" style="text-align:left"><span id=model></span></td></tr>
			<tr><td class="tabt">Serial</td><td class="tabv" style="text-align:left">
					<input type=text id=serial name=serial size="8" style="font-size: 18pt"></input></td></tr>

			<tr><td class="tabt">Group:</td><td colspan=3 class="tabv">
				<div class="tooltip"><span class="tooltiptext">
			  Devices in the same group bind together in the UI</span>
  <input type="text" id="group" oninput="chgroup()" maxlength=15 style="font-size: 18pt"></input></div></td></tr>
  
				<tr><td class="tabt">Role:</td><td colspan=3 class="tabv">
			<div class="tooltip"><span class="tooltiptext">
			  Name for role of this device within group</span>
  <input type="text" id="role" oninput="chrole()" maxlength=15 style="font-size: 18pt"></input></div></td></tr>
					
			<tr><td class="tabt">Factory Options</td><td class="tabv" style="text-align:left">
					<input type=text id=opts name=opts size="8" style="font-size: 18pt"></input></td></tr>
					
			<tr><td class="tabt">Let's Encrypt Account email</td><td class="tabv" style="text-align:left">
			<input type=text id=opts name=opts size="8" style="font-size: 18pt"></input></td></tr>
			
			<tr><td class="tabt">Let's Encrypt certificate DNS</td><td class="tabv" style="text-align:left">
			<input type=text id=opts name=opts size="8" style="font-size: 18pt"></input></td></tr>

			<tr><td colspan=2><input type=button class="btn" name="identify" value="ID Device"
				onclick="do_identify();" style="font-size: 18pt">&nbsp;
			<input type=button class="btn" name="identify" value="Reset"
				onclick="do_factory_reset();" style="font-size: 18pt">
			</td></tr>

		<tr><td colspan=2>
		<table><tr class=ras><td><img src="./ssl-pub.png"></td><td>
  <span style="font-size:14pt;">Public PEM SSL certificate: </span>
  <input type="file" name="pub" id="pub" size="20" accept=".pem" style="font-size: 12pt"><br>
  <span id=file_info style="font-size:12pt;"></span>
  <div id=warn-pub style="display:none"><table><tr><td><img src="./warning.png"></td><td>Certificate already exists</td></tr></table></div>
				</td></tr><tr class=ras><td><img src="./ssl-pri.png"></td><td>
  <span style="font-size:14pt;">Private PEM SSL key: </span>
  <input type="file" name="pri" id="pri" size="20" accept=".pem" style="font-size: 12pt"><br>
  	<span id=file_info style="font-size:12pt;"></span>
  <div id=warn-pri style="display:none"><table><tr><td><img src="./warning.png"></td><td>Certificate already exists</td></tr></table></div>

  		</td></tr><tr><td colspan=2>
	
  <input type="submit"  class="btn" id="upload" name="upload" value="Upload">
		</td></tr></table>

		</td></tr></table>
				</td></tr></table>
        </form>
    </article>
  
    <article class='dos'>

	<table class="center-div" style="width: 700px">
	 <tr><td  style="vertical-align:top;">
	    <table width=100% align=center><tr><td>
	       <table width=100% class="center-div" style="padding-top: 0px;" align=center>
		       <tr><td align=center><div id=aps></div></td></tr>
	       </table>
	     </td>
            </tr>
	    <tr><td align=center style="font-size: 16pt" width=100%>
		<div id=scanlist style="opacity: 0.35; width:100%">
		 <span id=pwt style="color:#808080">Passphrase: </span>
		 <input disabled type="password" id="pw" oninput="rch(1);" style="font-size: 18pt" size="8">
		 &nbsp;&nbsp;<input type=button class="btn" value="Update slot"
		 	disabled id=join onclick="do_join();">
			</div></td></tr>
	     <tr><td align=center width=100%>
	      <div id="scan" style="overflow:auto; width:100%; height:410px">Scanning...</div>
	     </td></tr>
	</table></td></tr></table>
     </article>
          
     <article class="tres">

      <table class="center-div" style="width: 450px">
       <tr><td align=center>
        <table>
         <tr><td colspan=2 class=stt width=100%>Application</td></tr>
         <tr><td><div id=img-ota-icon class=div64>
           <img id="img-ota-icon-img" src="setup.png" class=img128 style="top: -920px; left: -64px">
           </div></td>
           <td class=scc><div id=img-ota></div></td></tr>
           <tr><td colspan=2 align=center style="text-align:center"><div id=img-ota-upd></div></td></tr>
           <tr><td class=stt colspan=2 width=100%>Setup</td></tr>
           <tr><td><div id=img-factory-icon class=div64><img id="img-factory-icon-img" src="setup.png" class=img128 style="top: -920px; left: 0px"></div></td>
           <td class=scc><div id=img-factory></div></td></tr>
           <tr><td colspan=2 align=center style="text-align:center"><div id=img-factory-upd></div></td></tr>
         </table>
        </td></tr>

        <tr><td class=stt>Manual upload:</td></tr>
        <tr><td>
         <form name=multipart action="otaform" method="post" enctype="multipart/form-data" onsubmit="do_upload(this); return false;">
          <table width=100%>
           <tr><td><input type="file" name="ota" id="ota" size="20" accept=".bin" onchange="file_change();" style="font-size: 12pt"></td>
               <td><span id=file_info style="font-size:12pt;"></span></td></tr>
           <tr><td colspan=2>
            <input type="submit" class="btn" id="update" name="upload" disabled value="Upload">
            </td></tr>
           <tr><td colspan=2><progress id=progr value=0 max=100 class=progr>Upload Progress</progress></td></tr>
         </table>
        </form>
       </td></tr>

      </table>
      
     </article>

    </section>
   </td></tr>
  </table>
 </td></tr>
</table>


<script>
	var ws, sel, host, old, once = 0;
	
function san(s)
{
	if (!s)
		return "";
	if (s.search("<") != -1)
		return "invalid string";
	
	return s;
}

function image_summary(s)
{
	if (s.user)
		return san(s.app) + "<br>" + san(s.git) + "<br>" + san(s.user) +
			"@" + san(s.builder) + "<br>" + san(s.date);

	return "empty";
}

function get_appropriate_ws_url()
{
	var pcol;
	var u = document.URL;

	/*
	 * We open the websocket encrypted if this page came on an
	 * https:// url itself, otherwise unencrypted
	 */

	if (u.substring(0, 5) == "https") {
		pcol = "wss://";
		u = u.substr(8);
	} else {
		pcol = "ws://";
		if (u.substring(0, 4) == "http")
			u = u.substr(7);
	}

	u = u.split('/');

	/* + "/xxx" bit is for IE10 workaround */

	return pcol + u[0] + "/xxx";
}

	if (typeof MozWebSocket != "undefined")
		ws = new MozWebSocket(get_appropriate_ws_url(),
				      "esplws-scan");
	else
		ws = new WebSocket(get_appropriate_ws_url(),
				   "esplws-scan");

	try {
		ws.onopen = function() {
			document.getElementById("scan").textContent = "open";

		} 

		ws.onmessage =function got_packet(msg) {
			//document.getElementById("scan").innerHTML = "<pre>" + msg.data + "</pre>\n";
			var best, hit, n, m, s, b, a, cs, jso = JSON.parse(msg.data);
			
			cs = get_radio('ap');
		
			host = jso.host;
			if (once == 0) {
				document.getElementById("model").textContent = jso.model+"-"+jso.serial+"-"+jso.opts;
				document.getElementById("role").value = jso.role;

				if (jso.forced_button != 1)
					document.getElementById("access").innerHTML = "<span style=\"font-size:10pt;\">use physical button</span>";

				//document.getElementById("access").style.display = "block";
				s = "<table width=100%><tr><td class=l>Sel</td><td class=l>Slot</td><td class=l>AP</td>";
				s +=   "<td class=l>Use</td><td class=l>Clear</td></tr>";
				for (n = 0; n < 4; n++) {
					s += "<tr class=\"ra\"><td align=center style=\"overflow:hidden;\">"+
					     "<input type=radio name=slot value=\"" + parseInt(n) + "\" " +
					     "onchange=\"slch(" + parseInt(m) + ");\"></td><td>" +
					     parseInt(n + 1) + "</td>";

				     if (jso.known[n])
					     s += "<td width=50% id=slotap" + parseInt(n) + ">" +
						     jso.known[n].ssid + "</td>" +
					     "<td id=\"use"+n+"\">" + jso.known[n].use + "</td>";
				     else
					     s += "<td width=50% id=slotap" + parseInt(n) +
						     "></td><td></td>";
					if (jso.known[n].ssid.length)
					     s += "<td><button class=\"btn\" id=\"clr"+n+"\" style=\"font-size:8pt;\" onclick=\"clr(" +
							parseInt(n) + ")\">Clear</button></td></tr>";
					else
					     s += "<td><button disabled class=\"btn\" id=\"clr"+n+"\" style=\"font-size:8pt;\" onclick=\"clr(" +
							parseInt(n) + ")\">Clear</button></td></tr>";

				}

				s += "</table>";

				document.getElementById("aps").innerHTML = s;
				s = "";

				document.getElementById("group").value = jso.group;

				cs = jso.ssid;
				once = 1;
			}

			if (jso.auton) {

				document.getElementById("progr").value = parseInt(jso.pos / jso.len * 100);

				if (jso.pos == jso.len) {
					document.getElementById("realpage").style.display = "none";
					document.getElementById("waiting").style.display = "block";
					document.getElementById("progr").class = "progr-ok";
					setTimeout(function() { window.location.href = location.origin + "/"; }, 1000 );
				}

			} else {

			document.getElementById("img-factory").innerHTML = image_summary(jso.img_factory);
			document.getElementById("img-ota").innerHTML = image_summary(jso.img_ota);

			if (jso.latest.app && jso.latest.factory) {

				if (jso.latest.app && (!jso.img_ota.user || jso.img_ota.unixtime < jso.latest.app.unixtime)) {
									 document.getElementById("img-ota-upd").innerHTML = "<table width=100%><tr><td width=49%></td><td align=center><div id=img-ota-upd-icon class=div48><img id=\"img-ota-upd-icon-img\" src=\"setup.png\" class=img128 style=\"top: -984px; left: 0px\"></div></td><td><button onclick=\"get_latest(0);\" style=\"font-size: 14pt\">Update&nbsp;to&nbsp;latest</button></td><td width=49%></td></tr></table>";
				} else {
					document.getElementById("img-ota-upd").innerHTML = "<table width=100%><tr><td width=49%></td><td align=center><div id=img-ota-upd-icon class=div48><img id=\"img-ota-upd-icon-img\" src=\"setup.png\" class=img128 style=\"top: -984px; left: -48px\"></div></td><td>Already latest</td><td width=49%></td></tr></table>";
				}

				if (jso.latest.factory && (!jso.img_factory.user || jso.img_factory.unixtime < jso.latest.factory.unixtime)) {
					document.getElementById("img-factory-upd").innerHTML = 
						"<table width=100%><tr><td width=49%></td><td align=center><div id=img-factory-upd-icon class=div48>"+
						"<img id=\"img-factory-upd-icon-img\" src=\"setup.png\" class=img128 style=\"top: -984px; left: 0px\"></div>"+
						"</td><td><button onclick=\"get_latest(1);\" style=\"font-size: 14pt\">Update&nbsp;to&nbsp;latest</button>"+
						"<br>(NB: Updating Setup erases Application)</td><td width=49%></td></tr></table>";
				} else {
					document.getElementById("img-factory-upd").innerHTML =
						"<table width=100%><tr><td width=49%></td><td align=center><div id=img-factory-upd-icon class=div48>"+
						"<img id=\"img-factory-upd-icon-img\" src=\"setup.png\" class=img128 style=\"top: -984px; left: -48px\">"+
						"</div></td><td>Already latest</td><td width=49%></td></tr></table>";
				}

			}

			if (jso.inet == 1) {
				document.getElementById("inet").style.top = "-256px";
				document.getElementById("conn_td").class = "group2";
				document.getElementById("conn_data").style.display = "block";
				document.getElementById("conn_ap").textContent = jso.ssid;
				document.getElementById("conn_ip").textContent = jso.conn_ip;
				document.getElementById("conn_mask").textContent = jso.conn_mask;
				document.getElementById("conn_gw").textContent = jso.conn_gw;
			} else {
				document.getElementById("inet").style.top = "-382px";
				document.getElementById("conn_td").class = "";
				document.getElementById("conn_data").style.display = "none";
				document.getElementById("conn_ap").textContent = "";
				document.getElementById("conn_ip").textContent = "";
				document.getElementById("conn_mask").textContent = "";
				document.getElementById("conn_gw").textContent = "";
			}

			s = "<tr class=rl><td class=l style=\"overflow:hidden;width:24px;\">sel</td>"+
			    "<td class=l style=\"overflow:hidden;width:120px;\">SSID</td>"+
			    "<td class=l style=\"overflow:hidden;width:24px;\">Chan</td>"+
			    "<td class=l style=\"overflow:hidden;width:80px;\">RSSI</td>"+
			    "<td class=l style=\"overflow:hidden;width:30px;\">Auth</td>"+
			    "<td class=l style=\"overflow:hidden;width:120px;\">BSSID</td></tr>";
	
			for (m = 0; m < jso.aps.length; m++) {
			
				best = -128;

				for (n = 0; n < jso.aps.length; n++)
					if (parseInt(jso.aps[n].rssi) > best) {
						best = parseInt(jso.aps[n].rssi);
						hit = n;
					}
				b = 0;
				if (best > -76)
					b++;
				if (best > -71)
					b++;
				if (best > -65)
					b++;
				if (best > -61)
					b++;
		
				a= "";
				for (n = 0; n < 5; n++)
					if (n <= b)
						a = a + "&#x25C9;"; /* filled in */
					else
						a = a + "&#x25CC;";
				var sel = "", ra = "ra";
				if (cs == san(jso.aps[hit].ssid)) {
					sel = " checked=\"checked\" ";
					ra = "ras";
					rch(parseInt(jso.aps[hit].auth));
				}

				s = s + "<tr class=\"" + ra + "\" id=\""+san(jso.aps[hit].ssid)+"\">" +
					  "<td align=center style=\"overflow:hidden;\"><input type=radio name=ap value=\"" + san(jso.aps[hit].ssid) +
					  	"\" "+ sel + "onchange=\"rch(" + parseInt(jso.aps[hit].auth) +
					  	");\"></td>" +
					  	
					  "<td align=center style=\"overflow:hidden;\"><b>" + san(jso.aps[hit].ssid) + "</b></td>" +
					  "<td align=center style=\"overflow:hidden;\">" + san(jso.aps[hit].chan) + "</td>" +
					  "<td align=center style=\"overflow:hidden;\">" + a + "</td>" +
					  "<td align=center style=\"overflow:hidden;\"><div class=div24>"+
					        "<img class=img128 src=\"./setup.png\" style=\"top: -896px; left:-" +
						24 * parseInt(jso.aps[hit].auth) + "px\"></div></td>" +
					   "<td align=center style=\"overflow:hidden;\" ><span style=\"font-size:8pt\">" + san(jso.aps[hit].bssid) + "</span></td>" +
					"</tr>";
					
				jso.aps[hit].rssi = "-129";
			}
		
			document.getElementById("scan").innerHTML = 
				"<table style=\"table-layout:fixed; width:600px; word-break:break-all;border-spacing: 3px; padding: 3px;\">" + s + "</table>";

			document.getElementById("waiting").style.display = "none";
			document.getElementById("realpage").style.display = "block";
			}				
		} 

		ws.onclose = function(){
			// document.getElementById("scan").textContent = "closed";
		}
	} catch(exception) {
		alert('<p>Error' + exception);
	}

function slch(n)
{
	var q;

	document.getElementById("join").value = "Set slot " + parseInt(parseInt(get_radio('slot')) + 1);
	document.getElementById("scanlist").style.opacity = "1.0";
	document.getElementById('clr' + parseInt(n)).disabled = false;
}

function clr(n)
{
	var s = "{\"ssid" + parseInt(n) +"\":\"\",\"pw" + parseInt(n) + "\":\"\",\"slot\":\"" +
					parseInt(n) + "\"}";
	try {
		ws.send(s);
	} catch(exception) {
		alert('Sorry, there was a problem' + exception);
	}
	s = "slotap" + n;
	if ( document.getElementById(s))
		document.getElementById(s).textContent = "";
	document.getElementById("clr" + parseInt(n)).disabled = true;
	document.getElementById("use" + parseInt(n)).textContent = "0";
}

function chgroup()
{
	var s = "{\"group\":\"" + document.getElementById("group").value + "\"}";
	try {
		ws.send(s);
	} catch(exception) {
		alert('Sorry, there was a problem' + exception);
	}
}

function chrole()
{
	var s = "{\"role\":\"" + document.getElementById("role").value + "\"}";
	try {
		ws.send(s);
	} catch(exception) {
		alert('Sorry, there was a problem' + exception);
	}
}

function get_radio(name)
{
	var s = document.getElementsByName(name), sel;
	for ( var i = 0; i < s.length; i++)
	    if (s[i].checked) {
	        sel = s[i].value;
	        break;
	    }

	return sel;
}

function do_join()
{
	var s = "{\"ssid" + parseInt(get_radio('slot')) +"\":\"" + get_radio('ap') + "\",\"pw" +
		parseInt(get_radio('slot')) + "\":\"" +
			document.getElementById("pw").value + "\",\"slot\":\"" + parseInt(get_radio('slot')) + "\"}", h;
	try {
		ws.send(s);
	} catch(exception) {
		alert('Sorry, there was a problem' + exception);
	}

//	alert("AP set to " + get_radio('ap'));
/*
	if (document.getElementById("serial").value)
		h = document.getElementById("model").textContent + "-" +
		    document.getElementById("serial").textContent;
	else
		h = host;
	
	document.getElementById('main').innerHTML =
		"Thanks, the device is now using the new settings.  " +
		"Please reconnect yourself to AP <b>" + get_radio() +
		"</b> and access the device at " +
		"<a href=\"https://" + host + "\">http://" + h + "</a>";
*/
}

function set_access_pw()
{
	var s = "{\"setting\":\"1\",\"access_pw\":\"" +
			document.getElementById("access_pw").value + "\"}", h;
	try {
		ws.send(s);
	} catch(exception) {
		alert('Sorry, there was a problem' + exception);
	}
}


function do_identify()
{
	var s = "{\"identify\":\"1\"}";
	try {
		ws.send(s);
	} catch(exception) {
		alert('Sorry, there was a problem' + exception);
	}
}

function do_reset()
{
	var s = "{\"reset\":\"1\"}";
	try {
		ws.send(s);
	} catch(exception) {
		alert('Sorry, there was a problem' + exception);
	}

	ws.close();
	alert("Resetting...");
}

function file_change()
{
        document.getElementById('update').disabled = 0;
}

function reacquire()
{
	var xhr = new XMLHttpRequest();

	xhr.onreadystatechange = function(e) {
		if (xhr.readyState == 4) {
		   if (xhr.status == 200) {
			   setTimeout(function() { window.location.href = location.origin + "/"; }, 200 );
		   } else {
		   	setTimeout(function() { reacquire(); }, 500 );
		   }
		}
	};

	// xhr.timeout = 5;
	xhr.open("GET", location.origin + "/", true);
	xhr.send();
}

function do_upload(f)
{
	var xhr = new XMLHttpRequest();

        document.getElementById('update').disabled = 1;
	ws.close();
	document.getElementById("progr").class = "progr-ok";

	xhr.upload.addEventListener("progress", function(e) {
		document.getElementById("progr").value = parseInt(e.loaded / e.total * 100);

		if (e.loaded == e.total) {
			document.getElementById("realpage").style.display = "none";
			document.getElementById("waiting").style.display = "block";
		}
	
	}, false);

	xhr.onreadystatechange = function(e) {
		   console.log("rs" + xhr.readyState + " status " + xhr.status); 
		if (xhr.readyState == 4) {
			document.getElementById("realpage").style.display = "none";
			document.getElementById("waiting").style.display = "block";
			document.getElementById("progr").class = "progr-ok";
			setTimeout(function() { window.location.href = location.origin + "/"; }, 1000 );
		}
	};

	xhr.open("POST", f.action, true);
	xhr.send(new FormData(f));

	return false;
}

function get_latest(n)
{
	if (n == 0)
		ws.send("update-ota");
	else
		ws.send("update-factory");
}

function rch(need_pw)
{
	var _old = old, q;
	var sel = get_radio('ap');
	var butok = 1;

	if (sel == "")
		butok = 0;

        if (_old && _old != "" && _old != sel)
	      document.getElementById(_old).className = "ra";
	old = sel;

	q = "slotap" + get_radio("slot");
	if ( document.getElementById(q))
		document.getElementById(q).textContent = sel;

	if (sel && sel != "")
		if (document.getElementById(sel))
			document.getElementById(sel).className = "ras";

	document.getElementById('pw').disabled = !butok || need_pw == 0;
	if (!butok || need_pw == 0)
		document.getElementById('pwt').style.color = "#808080";
	else
		document.getElementById('pwt').style.color = "#000000";

	if (need_pw != 0)
		if (!document.getElementById("pw").value)
			butok = 0;

	document.getElementById('join').disabled = !butok;
}
	
</script>

</body>
</html>

